!function(){"use strict";const e=new class{constructor(){this.events={}}subscribe(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}publish(e,t){this.events[e]&&this.events[e].forEach(e=>e(t))}clear(){this.events={}}};class t{constructor(e=8){this.board=this.#e(e),this.boardSize=e,this.shipNodes={},this.targetHistory=[]}#e(e){let t,a=null;if(e<=0)return a;let i=[];for(let o=0;o<e;o++){t=[];for(let n=0;n<e;n++){let e=new s(n,o);if(a){let s=t.slice(-1)[0];s&&(e.left=s,s.right=e),i[n]&&(e.down=i[n],i[n].up=e)}else a=e;t.push(e)}i=[...t]}return a}navigateNode([e,t],s=this.board){let a,i=s;for(let t=e;0!==t;t=t<0?t+1:t-1){if(!i)return!1;a=t<0?"left":"right",i=i[a]}for(let e=t;0!==e;e=e<0?e+1:e-1){if(!i)return!1;a=e<0?"down":"up",i=i[a]}return i}isAllShipInBoard(){for(let e in this.shipNodes)if(0===this.shipNodes[e].nodes.length)return!1;return!0}isAllSunk(){for(let e in this.shipNodes)if(!this.shipNodes[e].ship.sunk)return!1;return!0}boardNodeArray(){const e=[];let t=null,s=null;for(let a=0;a<this.boardSize;a++)for(let a=0;a<this.boardSize;a++)if(0===a){const a=t?t.up:this.board;e.push(a),t=a,s=a}else{const t=s?.right;e.push(t),s=t}return e}boardNodeArrayRows(){const e=[];let t,s=null;for(let a=0;a<this.boardSize;a++){t=[];for(let e=0;e<this.boardSize;e++)if(0===e)t.push(s?s.up:this.board),s=t.slice(-1)[0];else{const e=t.slice(-1)[0]?.right;t.push(e)}e.unshift(t)}return e}}class s{constructor(e,t){this.x=e,this.y=t,this.up=null,this.down=null,this.left=null,this.right=null,this.ship=null}possibleMoves(e=""){const t=[];return this.up&&("false"!==this.up.fogElement.dataset.targeted&&"up"===e||t.push({node:this.up,direction:"up"})),this.down&&("false"!==this.down.fogElement.dataset.targeted&&"down"===e||t.push({node:this.down,direction:"down"})),this.left&&("false"!==this.left.fogElement.dataset.targeted&&"left"===e||t.push({node:this.left,direction:"left"})),this.right&&("false"!==this.right.fogElement.dataset.targeted&&"right"===e||t.push({node:this.right,direction:"right"})),t}}class a{constructor(e="default ship",t=3,s=2){this.name=e,this.length=t,this.width=s,this.numHit=0,this.sunk=!1,this.position="horizontal",this.draggableElement=null}hit(){return this.numHit++,this}isSunk(){const e=this.length*this.width;return this.numHit>=e&&(this.sunk=!0),this.sunk}}const i=(t,s,a,i)=>{const n=document.createDocumentFragment();for(let e=0;e<a;e++)for(let a=0;a<s;a++){const s=document.createElement("div");if(s.classList.add("ship-cell"),s.dataset.x=-a,s.dataset.y=e,n.appendChild(s),0===a&&0===e&&t.ship){const e=document.createElement("button");e.classList.add("btn-ship-rotate"),e.addEventListener("click",()=>{0!==t.ship.board.shipNodes[t.ship.name].nodes.length&&o(t,!0,i)}),t.ship.board&&0!==t.ship.board.shipNodes[t.ship.name].nodes.length&&e.classList.add("show"),s.appendChild(e);const a=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>rotate-right</title><path d="M16.89,15.5L18.31,16.89C19.21,15.73 19.76,14.39 19.93,13H17.91C17.77,13.87 17.43,14.72 16.89,15.5M13,17.9V19.92C14.39,19.75 15.74,19.21 16.9,18.31L15.46,16.87C14.71,17.41 13.87,17.76 13,17.9M19.93,11C19.76,9.61 19.21,8.27 18.31,7.11L16.89,8.53C17.43,9.28 17.77,10.13 17.91,11M15.55,5.55L11,1V4.07C7.06,4.56 4,7.92 4,12C4,16.08 7.05,19.44 11,19.93V17.91C8.16,17.43 6,14.97 6,12C6,9.03 8.16,6.57 11,6.09V10L15.55,5.55Z" /></svg>',"image/svg+xml").documentElement;e.appendChild(a),t.rotateButton=e}}const r=i.board.cellElement;t.style.gridTemplateColumns=`repeat(${s}, ${r.offsetWidth}px)`,e.subscribe("displayGameStatus",()=>{t.style.gridTemplateColumns=`repeat(${s}, ${r.offsetWidth}px)`}),e.subscribe("changedGameState",()=>{t.style.gridTemplateColumns=`repeat(${s}, ${r.offsetWidth}px)`}),window.addEventListener("resize",()=>{t.style.gridTemplateColumns=`repeat(${s}, ${r.offsetWidth}px)`}),t.replaceChildren(n)},o=(t,s=!1,a)=>{const o=t.ship;s&&(t.classList.remove(o.position),o.position="horizontal"===o.position?"vertical":"horizontal",t.classList.add(o.position),[o.width,o.length]=[o.length,o.width]),i(t,o.width,o.length,a);const n=document.createElement("div");n.classList.add("ship-draggable-display"),t.appendChild(n);const r=document.createElement("span");return r.textContent=o.name,n.appendChild(r),t.childNodes.forEach(s=>{s.addEventListener("mousedown",s=>{const a=s.currentTarget.dataset;e.publish("ship-mousedown",{position:[a.x,a.y],shipDraggable:t,ship:o}),t.dragShip=!0})}),t.addEventListener("mouseup",e=>{t.dragShip=!1,0===o.board.shipNodes[o.name].nodes.length&&t.resetRotation()}),t.addEventListener("dragover",e=>{e.preventDefault()}),t.addEventListener("dragenter",e=>{t.dragShip&&(e.currentTarget.style.visibility="hidden")}),t.addEventListener("dragend",s=>{s.currentTarget.style.visibility="visible",e.publish("ship-mousedown",null),t.dragShip=!1,0===o.board.shipNodes[o.name].nodes.length?(t.resetRotation(),t.rotateButton.classList.remove("show")):t.rotateButton.classList.add("show")}),t},n=(t,s,a,i=!0,o=!1)=>{let[n,r]=[a.width,a.length];const l=a.draggableElement;((e,t)=>{if(!t.shipNodes[e.name])return;let s=t.shipNodes[e.name].nodes.pop();for(;s;)s.ship=null,s=t.shipNodes[e.name].nodes.pop()})(a,s),l.style.top="unset",l.style.left="unset";let d=!1;if(t){let e=t;d=((e,t,s,a)=>{let i=e;for(let o=0;o<s;o++){if(!i)return!1;for(let e=0;e<t;e++){if(!i||i.ship)return!1;i=i.right}i=a.navigateNode([0,-o-1],e)}return!0})(t,n,r,s);for(let l=0;l<r;l++){for(let t=0;t<n;t++)e?(i?e.cellElement.classList.add(d?"highlight--green":"highlight--red"):(e.cellElement.classList.remove(d?"highlight--green":"highlight--red"),o&&d&&(e.ship=a,s.shipNodes[a.name].nodes.push(e))),e=e.right):t=n;e=s.navigateNode([0,-l-1],t),e||(l=r)}}if(o&&d&&l){const s=t.cellElement.getBoundingClientRect();l.style.top=`${s.top+window.scrollY}px`,l.style.left=`${s.left+window.scrollX}px`,window.addEventListener("resize",()=>{if(null===t.ship||t.ship!==a)return;const e=t.cellElement.getBoundingClientRect();l.style.top=`${e.top+window.scrollY}px`,l.style.left=`${e.left+window.scrollX}px`}),e.subscribe("changedGameState",()=>{if(null===t.ship||t.ship!==a)return;const e=t.cellElement.getBoundingClientRect();l.style.top=`${e.top+window.scrollY}px`,l.style.left=`${e.left+window.scrollX}px`})}return{shipMainNode:t,shipDraggable:l,isValidDrop:d}};let r=null;const l=t=>{const s=document.createDocumentFragment();return t.boardNodeArrayRows().forEach(e=>{e.forEach(e=>{const a=document.createElement("div");a.classList.add("fog-cell"),a.dataset.targeted=!1,a.boardNode=e,e.fogElement=a,d(a,t),s.appendChild(a)})}),e.subscribe("playerTurn",e=>{r=e}),s},d=(t,s)=>{t.addEventListener("click",()=>{if(r!==s&&null!==r&&"false"===t.dataset.targeted){if(t.dataset.targeted=!0,s.targetHistory.push(t.boardNode),t.boardNode.ship){if(t.classList.add("hit"),t.boardNode.ship.hit(),t.boardNode.ship.isSunk()&&(h(t.boardNode.ship.name,s),t.boardNode.ship.draggableElement.classList.add("show")),s.isAllSunk())return e.publish("allSunk",s),e.publish("setGameState","end"),void e.publish("announceWinner")}else t.classList.add("miss");e.publish("changePlayerTurn",s)}})},h=(e,t)=>{t.shipNodes[e].nodes.forEach(e=>{e.fogElement.classList.add("ship-sunk"),e.fogElement.classList.remove("hit")})},p=(s=8)=>{const r=document.querySelector(".game-area"),d=new t(s),h=document.createElement("div");h.classList.add("player-board"),r.appendChild(h);const p=document.createElement("div");p.classList.add("board-content"),h.appendChild(p);const c=document.createElement("div");c.classList.add("player-ships"),p.appendChild(c);const u=document.createElement("div");u.classList.add("player-ships-container"),c.appendChild(u);const m=document.createElement("div");m.classList.add("board-container"),p.appendChild(m);const g=document.createElement("div");g.classList.add("result-overlay"),m.appendChild(g),e.subscribe("allSunk",e=>{e===d?g.classList.add("lose"):g.classList.add("win")});const b=document.createElement("div");b.classList.add("cell-container"),m.appendChild(b),b.appendChild((t=>{const s=document.createDocumentFragment();return t.boardNodeArrayRows().forEach(a=>{a.forEach(a=>{const i=document.createElement("div");i.classList.add("board-cell"),i.boardNode=a,a.cellElement=i,((t,s)=>{let a=null;e.subscribe("ship-mousedown",e=>{a=e}),t.addEventListener("dragover",e=>{if(e.preventDefault(),!a)return;const{position:t,ship:i}=a,o=s.navigateNode([+t[0],+t[1]],e.currentTarget.boardNode);n(o,s,i)}),t.addEventListener("dragleave",e=>{if(!a)return;const{position:t,ship:i}=a,o=s.navigateNode([+t[0],+t[1]],e.currentTarget.boardNode);n(o,s,i,!1)}),t.addEventListener("drop",e=>{if(!a)return;const{position:t,ship:i}=a,o=s.navigateNode([+t[0],+t[1]],e.currentTarget.boardNode);n(o,s,i,!1,!0)})})(i,t),s.appendChild(i)})}),s})(d));const y=document.createElement("div");y.classList.add("fog-container"),y.appendChild(l(d)),m.appendChild(y);const f=document.createElement("div");f.classList.add("player-board-btns"),c.appendChild(f);const v=document.createElement("button");v.classList.add("player-ship-random"),v.textContent="Randomize",v.addEventListener("click",()=>{L()}),f.appendChild(v);const L=()=>{E();const e=d.shipNodes,t=d.boardNodeArray();for(let s in e){let a=Math.floor(Math.random()*t.length);Math.floor(2*Math.random())&&o(e[s].ship.draggableElement,!0,d);let i=n(t[a],d,e[s].ship,!1);for(;!i.isValidDrop;)a=Math.floor(Math.random()*t.length),i=n(t[a],d,e[s].ship,!1);e[s].ship.draggableElement.rotateButton.classList.add("show"),n(t[a],d,e[s].ship,!1,!0)}},C=document.createElement("button");C.classList.add("player-ship-reset"),C.textContent="Reset",C.addEventListener("click",()=>{E()}),f.appendChild(C);const E=()=>{for(let e in d.shipNodes)d.shipNodes[e].nodes.forEach(e=>{e.ship=null,e.fogElement.className="fog-cell"}),d.shipNodes[e].nodes=[],d.shipNodes[e].ship.numHit=0,d.shipNodes[e].ship.sunk=!1,d.shipNodes[e].ship.draggableElement.style.top="unset",d.shipNodes[e].ship.draggableElement.style.left="unset",d.shipNodes[e].ship.draggableElement.resetRotation(),d.shipNodes[e].ship.draggableElement.rotateButton.classList.remove("show");g.classList.remove("win"),g.classList.remove("lose"),y.replaceChildren(l(d)),y.classList.remove("show"),e.publish("setGameState","placement")};return{addBoardShip:(t,s,r)=>{const l=((t,s,n,r)=>{const l=new a(t,n,s),d=document.createElement("div");d.classList.add("ship-container");const h=document.createElement("div");h.classList.add("ship-draggable","horizontal"),h.draggable=!0,h.ship=l,h.resetRotation=()=>{"vertical"===l.position&&o(h,!0,r)},e.subscribe("changedGameState",e=>{h.draggable="placement"===e}),d.appendChild(h),l.shipDraggable=h,o(h,!1,r);const p=document.createElement("div");return p.classList.add("ship-placement-bg"),i(p,l.width,l.length,r),d.appendChild(p),l.draggableElement=h,{shipContainer:d,shipDraggable:h,shipObj:l}})(t,s,r,d);l.shipObj.board=d,u.appendChild(l.shipContainer),d.shipNodes[t]={ship:l.shipObj,nodes:[]},l.shipDraggable.addEventListener("click",()=>{const e=d.shipNodes[t].nodes[0];n(e,d,l.shipObj,!1,!0),0===d.shipNodes[t].nodes.length&&l.shipDraggable.resetRotation()})},resetBoard:E,randomPlacement:L,resultOverlay:g,playerBoard:h,board:d}};let c=1;class u{constructor(e,t=!1){this.name=e,this.playerNumber=c++,this.isComputer=t,this.boardComponent=p(),this.board=this.boardComponent.board,this.#t(),this.#s(),t?(this.boardComponent.randomPlacement(),this.boardComponent.playerBoard.dataset.player="computer"):this.boardComponent.playerBoard.dataset.player="human"}#s(){const e=document.createElement("h2");e.classList.add("player-name"),e.textContent=this.name,this.boardComponent.playerBoard.prepend(e)}#t(){this.boardComponent.addBoardShip("Carrier",4,1),this.boardComponent.addBoardShip("Cruiser",3,1),this.boardComponent.addBoardShip("Submarine",3,1),this.boardComponent.addBoardShip("Destroyer",2,1),this.boardComponent.addBoardShip("Dreadnought",3,2)}}class m{constructor(e,t){this.player1=e,this.player2=t,this.#a(),this.#i(),this.#o(),this.#n(),this.#r()}#r(){const t=document.querySelector(".btn-new");e.subscribe("announceWinner",()=>{"player 1"===document.querySelector(".game-area").dataset.turn?e.publish("displayGameStatus",[`Winner: ${this.player1.name}`,`${this.player2.name}'s ships has all been sunk.`]):e.publish("displayGameStatus",[`Winner: ${this.player2.name}`,`${this.player1.name}'s ships has all been sunk.`]),t.classList.add("show")})}#n(){e.subscribe("setPlayerPlacement",t=>{this.player1.boardComponent.playerBoard.classList.add("hide"),this.player2.boardComponent.playerBoard.classList.add("hide"),"player 1"===t?(this.player1.boardComponent.playerBoard.classList.remove("hide"),e.publish("displayGameStatus",[this.player1.name,"Place your ships"])):"player 2"===t&&(this.player2.boardComponent.playerBoard.classList.remove("hide"),e.publish("displayGameStatus",[this.player2.name,"Place your ships"]))})}#o(){e.subscribe("setGameState",e=>{this.changeGameState(e)})}#a(t=this.player1.board){const s=document.querySelector(".game-area");t===this.player1.board?s.dataset.turn="player 1":s.dataset.turn="player 2",e.publish("playerTurn",t)}#i(){e.subscribe("changePlayerTurn",t=>{let s=null;this.player1.board===t?(s=this.player1.board,e.publish("displayGameStatus",[`Turn: ${this.player1.name}`,"Select a cell to attack."])):(s=this.player2.board,e.publish("displayGameStatus",[`Turn: ${this.player2.name}`,this.player2.isComputer?"Computer is thinking.":"Select a cell to attack."]),this.player2.isComputer&&this.#l()),this.#a(s)})}#d=[];#h=()=>{const e=[];this.#d.forEach(t=>{!1===t.node.ship.sunk&&e.push(t)}),this.#d=e};#l(){const e=this.player1.board.boardNodeArray();this.#h();let t,s=null;if(0===this.#d.length){for(;!s;)t=Math.floor(Math.random()*e.length),"false"===e[t].fogElement.dataset.targeted&&(s=e[t]);s.ship&&this.#d.push({node:s,possibleMoves:s.possibleMoves(),suggestMove:null})}else{let e,t,a,i=1,o=this.#d.slice(-i)[0];for(;!e;)t=o.suggestMove?o.possibleMoves.findIndex(e=>e.direction===o.suggestMove):Math.floor(Math.random()*o.possibleMoves.length),a=o.possibleMoves.splice(t,1)[0],"false"===a.node.fogElement.dataset.targeted&&(e=a),0===o.possibleMoves.length&&(this.#d.splice(-1),o=this.#d.slice(-1)[0]);console.log(e),s=e.node;const n=s.possibleMoves();s.ship?this.#d.push({node:s,possibleMoves:n,suggestMove:n.find(t=>t.direction===e.direction)?e.direction:null}):o.suggestMove=null}setTimeout(()=>{console.log(this.#d),s.fogElement.click()},1e3)}changeGameState(t){const s=document.querySelector(".game-area");s.dataset.mode=t||("placement"===s.dataset.mode?"game":"placement"),"game"===s.dataset.mode&&(this.player1.boardComponent.playerBoard.classList.remove("hide"),this.player2.boardComponent.playerBoard.classList.remove("hide"),e.publish("displayGameStatus",["Turn: Player 1","Select a cell to attack."])),e.publish("changedGameState",s.dataset.mode)}resetBoard(){this.player1.boardComponent.resetBoard(),this.player2.boardComponent.resetBoard(),this.#a()}}const g=document.querySelector(".game-canvas"),b=document.querySelector(".game-area"),y=document.querySelector(".game-select"),f=document.querySelectorAll(".btn-game-select"),v=document.querySelector(".btn-next"),L=document.querySelector(".btn-start"),C=document.querySelector(".btn-new");let E,w;f.forEach(e=>{e.addEventListener("click",e=>{y.classList.add("hide"),S(),"player"===e.currentTarget.dataset.mode?(g.classList.add("show"),N(),v.classList.add("show")):(g.classList.add("show"),N(!0),L.classList.add("show"))})});const S=()=>{e.subscribe("displayGameStatus",([e,t])=>{const s=document.querySelector(".game-status--primary"),a=document.querySelector(".game-status--secondary");a.classList.remove("animate"),e&&(s.textContent=e),t&&(a.textContent=t,setTimeout(()=>{a.classList.add("animate")},1))})},N=(t=!1)=>{b.replaceChildren();const s=new u("Player 1"),a=new u(t?"Computer":"Player 2",t),i=new m(s,a);e.publish("setPlayerPlacement","player 1"),e.publish("setGamestate",i),B(i)},B=t=>{E=new AbortController,w=E.signal,v.addEventListener("click",()=>{t.player1.board.isAllShipInBoard()?(b.dataset.turn="player 2",v.classList.remove("show"),L.classList.add("show"),e.publish("setPlayerPlacement","player 2")):e.publish("displayGameStatus",[,"Place all your ships first to proceed."])},{signal:w}),L.addEventListener("click",()=>{let s=null;s="player 1"===b.dataset.turn?t.player1.board:t.player2.board,s.isAllShipInBoard()?(b.dataset.turn="player 1",e.publish("setGameState","game"),L.classList.remove("show")):e.publish("displayGameStatus",[,"Place all your ships first to proceed."])},{signal:w}),C.addEventListener("click",()=>{y.classList.remove("hide"),g.classList.remove("show"),b.dataset.mode="placement",e.clear(),E.abort(),C.classList.remove("show")},{signal:w})}}();